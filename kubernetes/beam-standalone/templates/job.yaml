apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "beam-simulation.job" . }}
  namespace: {{ .Values.global.namespace }}
  labels:
    app: {{ template "beam-simulation.job" . }}
    {{- include "beam-simulation.release_labels" . | indent 4 }}
spec:
  template:
    metadata:
      labels:
        app: {{ template "beam-simulation.job" . }}
        node: master
    spec:
      hostname: {{ .Values.job.hostname }}
      restartPolicy: Never

      volumes:
        - name: {{ .Values.volume.output.name }}
          emptyDir: {}
        - name: {{ .Values.volume.data.name }}
          hostPath:
            path: {{ .Values.volume.data.host }}

      imagePullSecrets:
        - name: {{ .Values.global.secret.docker }}

      containers:

        - name: simulation-{{ template "beam-simulation.job" . }}
          image: {{ .Values.job.image }}:{{ .Values.job.imageTag }}
          resources:
            limits:
              cpu: "1.5"
              memory: 4Gi
            requests:
              cpu: "1"
              memory: 3Gi
          args: ["--config", {{ printf "%s/sf-light/sf-light-25k.conf" .Values.volume.data.path | quote }}, "--cluster-type", "master", "--node-host", {{ .Values.job.hostname | quote }}, "--node-port", "2552", "--seed-address", {{ printf "%s:2552" .Values.job.hostname | quote }}, "--use-local-worker", "true"]
          imagePullPolicy: Always
          env:
            - name: BEAM_OUTPUT
              value: {{ .Values.volume.output.path | quote }}
            - name: JAVA_OPTS
              value: '"-Xmx2G" "-Xms1G" "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005"'
          ports:
            # akka remoting
            - name: {{ .Values.service.akkaPort.name | quote }}
              containerPort: {{ .Values.service.akkaPort.port }}
              protocol: TCP
            - name: debug
              containerPort: 5005
              hostPort: 5005
              protocol: TCP
          volumeMounts:
            - name: {{ .Values.volume.output.name }}
              mountPath: {{ .Values.volume.output.path }}
            - name: {{ .Values.volume.data.name }}
              mountPath: {{ .Values.volume.data.path }}